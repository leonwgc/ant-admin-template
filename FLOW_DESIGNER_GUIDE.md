# 可视化流程设计器使用指南

## 📋 功能概述

可视化流程设计器是一个基于 **React Flow** 构建的拖拽式流程图编辑工具，支持创建、编辑和保存业务流程图。

### ✨ 核心特性

- 🎨 **4 种节点类型**：开始节点、处理节点、决策节点、结束节点
- 🔗 **灵活连接**：节点间可自由连接，支持动画效果
- ✏️ **节点编辑**：右键点击节点弹出 Popover 快速编辑
- 💾 **自动保存**：流程图自动保存到 localStorage
- 🎯 **缩放控制**：支持放大、缩小、适应视图
- 🌐 **国际化**：完整的中英文支持

---

## 🎨 节点类型

### 1. 开始节点（Start Node）
- **颜色**：绿色
- **图标**：▶️ PlayCircle
- **用途**：标记流程的起始点
- **特点**：只有输出连接点

### 2. 处理节点（Process Node）
- **颜色**：蓝色
- **图标**：⚡ Thunder
- **用途**：表示处理步骤或操作
- **特点**：有输入和输出连接点

### 3. 决策节点（Decision Node）
- **颜色**：橙色
- **图标**：🌳 Branches
- **用途**：表示条件判断或分支
- **特点**：菱形形状，可多分支

### 4. 结束节点（End Node）
- **颜色**：红色
- **图标**：✅ CheckCircle
- **用途**：标记流程的结束点
- **特点**：只有输入连接点

---

## 🛠️ 工具栏功能

### 节点操作
| 按钮 | 功能 | 快捷键 |
|------|------|--------|
| 开始节点 | 添加开始节点 | - |
| 处理节点 | 添加处理节点 | - |
| 决策节点 | 添加决策节点 | - |
| 结束节点 | 添加结束节点 | - |

### 视图控制
| 按钮 | 功能 | 说明 |
|------|------|------|
| 放大 | 放大画布 | 增加缩放级别 |
| 缩小 | 缩小画布 | 减少缩放级别 |
| 适应视图 | 自动调整 | 让所有节点可见 |

### 流程管理
| 按钮 | 功能 | 说明 |
|------|------|------|
| 保存 | 保存流程 | 保存到 localStorage |
| 清空 | 清空画布 | 删除所有节点和连线 |

---

## 📖 使用教程

### 1. 添加节点
1. 点击工具栏中的节点按钮（如"处理节点"）
2. 节点会自动添加到画布上的随机位置
3. 拖拽节点到合适的位置

### 2. 连接节点
1. 鼠标悬停在节点的**连接点**上（小圆点）
2. 按住鼠标左键拖拽到目标节点的连接点
3. 释放鼠标完成连接
4. 连线会显示动画效果

### 3. 编辑节点
1. **右键点击**节点，弹出配置 Popover
2. 可以编辑：
   - **节点名称**（必填）
   - **节点描述**（可选）
3. 点击"保存"按钮应用更改

### 4. 删除节点
1. 右键点击要删除的节点，弹出配置 Popover
2. 在 Popover 中点击**"删除"**按钮
3. 节点及其所有连线都会被删除

### 5. 删除连接
支持两种方式删除连接线：

**方式 1：键盘删除**
1. 单击选中要删除的连接线（连线会高亮）
2. 按下 `Delete` 或 `Backspace` 键
3. 连接线会被删除

**方式 2：点击删除按钮**
1. 鼠标悬停在连接线上
2. 连接线中间会显示🔴删除图标
3. 点击删除图标即可删除连接

### 6. 保存流程
1. 编辑完成后，点击工具栏的**"保存"**按钮
2. 流程图会保存到浏览器的 localStorage
3. 刷新页面后，流程图会自动恢复（功能待实现）

---

## 🎯 实战示例

### 示例 1：简单审批流程

```
开始
  ↓
提交申请（处理节点）
  ↓
主管审批（决策节点）
  ├─ 批准 → 完成（结束节点）
  └─ 驳回 → 修改申请（处理节点）→ 提交申请
```

**创建步骤**：
1. 添加"开始节点"，命名为"开始"
2. 添加"处理节点"，命名为"提交申请"
3. 添加"决策节点"，命名为"主管审批"
4. 添加"结束节点"，命名为"完成"
5. 添加"处理节点"，命名为"修改申请"
6. 连接：开始 → 提交申请 → 主管审批
7. 连接：主管审批 → 完成（批准分支）
8. 连接：主管审批 → 修改申请 → 提交申请（驳回分支）

---

### 示例 2：订单处理流程

```
开始
  ↓
接收订单
  ↓
库存检查（决策）
  ├─ 有库存 → 配货 → 发货 → 结束
  └─ 无库存 → 通知客户 → 结束
```

---

## 🎨 节点样式自定义

每种节点都有独特的视觉样式：

```scss
开始节点：绿色渐变背景 + 圆角矩形
处理节点：蓝色渐变背景 + 圆角矩形
决策节点：橙色渐变背景 + 菱形（45° 旋转）
结束节点：红色渐变背景 + 圆角矩形
```

---

## 🔧 高级功能

### 1. 数据持久化

流程数据会自动保存到 localStorage：

```typescript
// 保存的数据结构
{
  nodes: [...],      // 所有节点
  edges: [...],      // 所有连线
  timestamp: Date    // 保存时间
}
```

### 2. 扩展节点类型

可以在 `CustomNode.tsx` 中添加新的节点类型：

```typescript
export type CustomNodeType =
  | 'start'
  | 'process'
  | 'decision'
  | 'end'
  | 'custom';  // 新增自定义类型
```

### 3. 服务器端保存

当前版本保存到 localStorage，可以扩展为 API 调用：

```typescript
const handleSave = async () => {
  const flowData = { nodes, edges };

  // 调用 API 保存到服务器
  await fetch('/api/flows', {
    method: 'POST',
    body: JSON.stringify(flowData),
  });
};
```

---

## 📱 响应式设计

流程设计器支持响应式布局：
- **桌面端**：全功能工具栏 + 大画布
- **平板端**：简化工具栏 + 中等画布
- **移动端**：基础功能 + 触摸操作

---

## 🐛 常见问题

### Q1: 节点无法拖动？
**A**: 检查节点是否被选中，确保没有其他面板覆盖画布。

### Q2: 右键点击节点没有反应？
**A**: 确保点击的是节点而非连接线，Popover 会在鼠标位置附近弹出。点击空白区域可关闭 Popover。

### Q3: 连线无法创建？
**A**: 确保从输出连接点（底部）拖到输入连接点（顶部）。

### Q4: 如何删除连接线？
**A**: 有两种方式：
1. 点击选中连接线，然后按 `Delete` 或 `Backspace` 键
2. 鼠标悬停在连接线上，点击显示的🔴删除图标

### Q5: 保存后刷新页面数据丢失？
**A**: 当前版本自动恢复功能待实现，可以手动在页面加载时读取 localStorage。

### Q6: 如何导出流程图为图片？
**A**: 可以使用浏览器的截图功能，或集成 `html2canvas` 库。

---

## ⌨️ 快捷键

| 快捷键/操作 | 功能 | 说明 |
|--------|------|------|
| 鼠标左键拖拽 | 移动节点 | 拖动节点到任意位置 |
| 鼠标右键点击节点 | 编辑节点 | 在鼠标位置弹出配置 Popover |
| `Delete` | 删除连接 | 选中连接线后按此键删除 |
| `Backspace` | 删除连接 | 选中连接线后按此键删除 |
| 鼠标滚轮 | 缩放画布 | 滚轮上下滚动进行缩放 |
| 鼠标拖拽画布 | 平移视图 | 在空白区域拖动画布 |

---

## 🚀 未来计划

- [ ] 自动恢复上次编辑的流程
- [ ] 导出为 PNG/SVG/JSON
- [ ] 撤销/重做功能
- [ ] 节点模板库
- [ ] 多人协作编辑
- [ ] 流程验证（检查死循环、孤立节点等）
- [ ] 流程执行引擎
- [ ] 流程版本管理

---

## 📚 相关资源

- **React Flow 官网**: https://reactflow.dev/
- **组件文档**: `src/pages/FlowDesigner/`
- **节点组件**: `src/pages/FlowDesigner/nodes/CustomNode.tsx`
- **工具栏**: `src/pages/FlowDesigner/components/Toolbar.tsx`
- **配置 Popover**: `src/pages/FlowDesigner/components/NodePopover.tsx`

---

## 🎓 技术栈

- **React Flow 11.11.4** - 流程图核心库
- **React 18.3.1** - UI 框架
- **TypeScript** - 类型安全
- **Ant Design 5.x** - UI 组件库
- **i18next** - 国际化
- **SCSS** - 样式预处理

---

## 💡 技巧和最佳实践

1. **合理布局**：从上到下、从左到右排列节点
2. **命名规范**：使用清晰的节点名称，如"审批"而非"步骤1"
3. **添加描述**：为复杂节点添加详细描述
4. **定期保存**：编辑过程中定期点击保存按钮
5. **使用决策节点**：明确标注分支条件
6. **避免交叉连线**：保持流程图整洁

---

需要帮助？查看项目文档或联系开发团队！🎉
